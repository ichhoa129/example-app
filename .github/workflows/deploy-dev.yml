on:
  push:
    branches:
      - develop

name: "[DEV] Deploy image to K8S"

jobs:
  deploy:
    environment: example-app-dev
    name: Deploy App to K8S
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: login to docker registry
        uses: docker/login-action@v3
        with:
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}

      - name: Add SHORT_SHA env property with commit short sha
        run: echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-6`" >> $GITHUB_ENV

      - name: Build, tag, and push image to DockerHub
        id: build-image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }} 
        run: |
          # Build a docker container and
          # push it to ECR so that it can
          # be deployed to ECS.
          docker build -t $DOCKERHUB_USERNAME/${{ vars.DOCKERHUB_REPOSITORY }}:${{vars.ENV}}-${SHORT_SHA} -f ./docker/Dockerfile .
          docker push $DOCKERHUB_USERNAME/${{ vars.DOCKERHUB_REPOSITORY }}:${{vars.ENV}}-${SHORT_SHA}
          echo "::set-output name=image::$DOCKERHUB_USERNAME/${{ vars.DOCKERHUB_REPOSITORY }}:${{vars.ENV}}-${SHORT_SHA}"

      - name: Modify value file
        shell: bash
        env:
          version: ${{ steps.build-image.outputs.image }}
          configRepo: ${{ vars.CONFIG_REPO }}
          gitHubUser: ${{ secrets.GH_USER }}
          branch: ${{ vars.CONFIG_REPO_BRANCH }}
          valueFile: ${{ vars.CONFIG_REPO_VALUE_FILE }}
        run: |
          [[ -d ${configRepo} ]] && rm -r ${configRepo}
          git clone https://github.com/${gitHubUser}/${configRepo}.git --branch ${branch}
          cd ${configRepo}
          git config user.email "cicd@gmail.com"
          git config user.name "cicd"
          sed -i 's|  tag: .*|  tag: '\"${version}\"'|' ${valueFile}
          git add . ; git commit -m "Update to version ${version}";git push https://${{ secrets.GH_TOKEN }}@github.com/${gitHubUser}/${configRepo}.git
          [[ -d ${configRepo} ]] && rm -r ${configRepo}
          echo "::set-output name=version::$version"